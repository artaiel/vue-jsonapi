var VueJsonapi=function(t,a){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function h(i){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?e(Object(a),!0).forEach(function(t){var e,n,r;e=i,r=a[n=t],n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(a,t))})}return i}a=a&&a.hasOwnProperty("default")?a.default:a;function o(t,e){var n=0<arguments.length&&void 0!==t?t:{};return(1<arguments.length&&void 0!==e?e:[]).reduce(function(t,e){return t[e]=n[e],t},{})}function s(t,e){var n=0<arguments.length&&void 0!==t?t:{},r=1<arguments.length&&void 0!==e?e:[];return Object.keys(n).reduce(function(t,e){return r.includes(e)||(t[e]=n[e]),t},{})}function d(t,r,e){var i=2<arguments.length&&void 0!==e?e:{};r.reduce(function(t,e,n){return t[e]||a.set(t,e,n<r.length-1?{}:i),t[e]},t)}function c(t){return Array.isArray(t)?t.map(function(t){return s(t,["attributes"])}):s(t,["attributes"])}function l(t){return(Array.isArray(t)?t:[t]).filter(Boolean)}var u="network-only",f="cache-and-network",p="cache-first",v="cache-only",y="no-cache",g="pending",b={config:function(){throw Error("No action specified!")},fetchPolicy:u},O=function(){function r(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};i(this,r),this.name=e,this.rawOptions=h({},b,{},n),this.vm=t,this.watchers=[],this.observable=a.observable({info:{}}),this.init(),this.run()}return n(r,[{key:"init",value:function(){this.watchers.push(this.vm.$watch(this.computeOptions.bind(this),this.onComputeOptionsChange.bind(this)),this.vm.$watch(this.readCachedRequest.bind(this),this.onRequestDataChange.bind(this),{deep:!0}))}},{key:"destroy",value:function(){this.watchers.forEach(function(t){return t()})}},{key:"run",value:function(t){var e=0<arguments.length&&void 0!==t?t:this.computeOptions(),n=e.skip,r=e.config,i=e.fetchPolicy;if(!n){var a,o=this.createRequestInfo(r);if(this.info=o,[f,p,v].includes(i)&&(a=this.fetchFromCache()),[f,u,y].includes(i)||i===p&&!a){var s=i===y;this.fetch({config:r,noCache:s},o)}}}},{key:"createRequestInfo",value:function(t){return{requestId:this.$jsonapi.cache.getRequestId(t),status:"idle"}}},{key:"readCachedRequest",value:function(){var t=this.info.requestId;return this.$jsonapi.cache.readRequest(t)}},{key:"fetchFromCache",value:function(){var t=(this.request||{}).data;return t&&(this.data=t),t}},{key:"fetch",value:function(t,e){var n=this,r=1<arguments.length&&void 0!==e?e:this.info;return r.status=g,this.$jsonapi.request(t).then(function(t){return r.status="success",t}).catch(function(t){if(r.status="error",n.rawOptions.error)return n.rawOptions.error.call(n.vm,t),null;throw t})}},{key:"refetch",value:function(){var t=this.computeOptions(),e=t.skip,n=t.config,r=t.fetchPolicy;if(!e){var i=r===y;return this.fetch({config:n,noCache:i})}}},{key:"onComputeOptionsChange",value:function(t,e){var n,r,i=["variables","skip"];o(t,i),n=o(t,i),r=o(e,i),JSON.stringify(n)!==JSON.stringify(r)&&this.run(t)}},{key:"computeOptions",value:function(){var t="function"==typeof this.rawOptions.skip?this.rawOptions.skip.call(this.vm):this.rawOptions.skip;if(t)return{skip:t};var e="function"==typeof this.rawOptions.variables?this.rawOptions.variables.call(this.vm):this.rawOptions.variables,n="function"==typeof this.rawOptions.config?this.rawOptions.config.call(this.vm,e):this.rawOptions.config;return h({},this.rawOptions,{variables:e,config:n,skip:t})}},{key:"onRequestDataChange",value:function(t){if(t)return this.data=t.data}},{key:"$jsonapi",get:function(){return this.vm.$jsonapi}},{key:"loading",get:function(){return this.info.status===g}},{key:"info",get:function(){return this.observable.info},set:function(t){return this.observable.info=t}},{key:"data",set:function(t){if(t){var e=this.rawOptions.update?this.rawOptions.update.call(this.vm,t,this.request):t;if(!Object.prototype.hasOwnProperty.call(this.vm,this.name))return void("production"!==process.env.NODE_ENV&&console.warn("Default value for jsonapi query is not specified in component's `data` object."));this.vm.$set(this.vm,this.name,e)}}},{key:"request",get:function(){return this.readCachedRequest()}}]),r}(),w=function(){function r(t){var e=t.cache,n=t.client;i(this,r),this.cache=e,this.client=n,this.queries={}}return n(r,[{key:"addQuery",value:function(t,e,n){this.queries[e]=new O(t,e,n)}},{key:"destroy",value:function(){Object.values(this.queries).forEach(function(t){return t.destroy()})}},{key:"request",value:function(t){var r=this,i=t.config,a=t.noCache,o="get"===i.method;return o&&!a&&this.cache.initRequest(i),this.client.request(i).then(function(t){var e=r.cache.parseResponse(i,t),n=h({},t,{data:h({},t.data,{data:t.data.data&&c(t.data.data),included:t.data.included&&c(t.data.included)})});return a||(e.persist(),o&&r.cache.writeRequestData(i,e.getData,n)),{raw:n,get data(){return e.getData()}}})}}]),r}(),m={getRequestId:function(t){var e=t.method,n=t.url;return"".concat(e,":").concat(n)},getRecordId:function(t){var e=t.type,n=t.id;return"".concat(e,":").concat(n)}},k=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.options=h({},m,{},t),this.actionIndex=0,this.state=a.observable({records:{},requests:{}})}return n(e,[{key:"initRequest",value:function(t){var e=this.getRequestId(t);d(this.state.requests,[e],Object.freeze({requestId:e,data:function(){return null}}))}},{key:"writeRequestData",value:function(t,e,n){var r=this.getRequestId(t);return this.state.requests[r]=Object.freeze(h({},this.state.requests[r],{timestamp:+new Date,data:e,raw:n})),this.state.requests[r]}},{key:"readRequest",value:function(t){var e=this.state.requests[t];return e&&h({},e,{get data(){return e.data()}})}},{key:"read",value:function(t){return this.state.records[this.getRecordId(t)]}},{key:"parseResponse",value:function(t,e){var c=this;if("get"===t.method&&200===e.status||"post"===t.method&&[200,201].includes(e.status)||"patch"===t.method&&[200,201,204].includes(e.status)){var n=["post","patch"].includes(t.method)&&204===e.status?t.data:e.data.data,r=e.data.included,i=this.collectRecords(n),a=l(n).concat(r||[]),o=a.map(this.getRecordId),s=Array.from(i).map(function(e){return function(t){return d(t.state.records,[e],null)}}).concat(o.map(function(e){return function(t){return d(t.state.records,[e],{})}})).concat(a.map(function(s){return function(t){var n,e,r,i,a=c.getRecordId(s),o=function(r){for(var t=arguments.length,e=new Array(1<t?t-1:0),n=1;n<t;n++)e[n-1]=arguments[n];return e.forEach(function(n){Object.keys(n).forEach(function(t){var e=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(r,t,h({},e,{configurable:!0}))})}),r}({},t.state.records[a],(n=t,r=h({__type:(e=s).type,id:e.id},e.attributes),i=e.relationships||{},Object.keys(i).forEach(function(t){var e=i[t].data;e&&Object.defineProperty(r,t,{get:function(){return Array.isArray(e)?e.map(function(t){return n.read(t)}):n.read(e)},enumerable:!0,configurable:!0})}),r));t.state.records[a]=Object.freeze(o)}})),u=null,f=function(t){return function(){return Array.isArray(n)?n.map(t.read.bind(t)):t.read(n)}};return{persist:function(){s.forEach(function(t){return t(c)}),u=f(c)},getData:function(){if(u)return u();var e={records:[]},n={state:e,read:function(t){return e.records[c.getRecordId(t)]}};return s.forEach(function(t){return t(n)}),(u=f(n))()}}}return{persist:function(){},getData:function(){return e}}}},{key:"collectRecords",value:function(t,e){var n=this,r=1<arguments.length&&void 0!==e?e:new Set;return t&&(l(t).map(this.getRecordId).forEach(function(t){return r.add(t)}),l(t).forEach(function(t){var e=t.relationships||{};Object.keys(e).forEach(function(t){return n.collectRecords(e[t].data,r)})})),r}},{key:"getRecordId",get:function(){return this.options.getRecordId}},{key:"getRequestId",get:function(){return this.options.getRequestId}}]),e}(),j=w;j.install=function t(e,n){var r=n.cache,i=n.client;t.installed||(t.installed=!0,e.config.optionMergeStrategies.jsonapi=e.config.optionMergeStrategies.computed,Object.defineProperty(e.prototype,"$jsonapi",{get:function(){return this.$_jsonapi||(this.$_jsonapi=new w({cache:r,client:i})),this.$_jsonapi}}),e.mixin({created:function(){var e=this,n=this.$options.jsonapi;n&&Object.keys(n).forEach(function(t){e.$jsonapi.addQuery(e,t,n[t])})},beforeDestroy:function(){this.$_jsonapi&&this.$_jsonapi.destroy()}}))};var q=null;return"undefined"!=typeof window?q=window.Vue:"undefined"!=typeof global&&(q=global.Vue),q&&q.use(j),t.Cache=k,t.default=j,t}({},Vue);
